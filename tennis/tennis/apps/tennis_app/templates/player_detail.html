{% extends 'base.html' %}
{% block title %}{{ player.full_name }} ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}
{% block content %}
  <h1>üë§ {{ player.full_name }}</h1>
  <div class="content">
    <!-- –§–∏–ª—å—Ç—Ä –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–∞—Ä–Ω—ã—Ö –∏–≥—Ä -->
    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--card-background); border-radius: 8px; border: 1px solid var(--border-color);">
      <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
        <input type="checkbox" id="includeDoublesCheckbox" {% if include_doubles %}checked{% endif %} 
               style="width: 18px; height: 18px; cursor: pointer;">
        <span>–í–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</span>
      </label>
      <div id="loadingIndicator" style="display: none; margin-top: 0.5rem; color: var(--text-muted);">
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
      </div>
    </div>
    
    <div class="dashboard-cards" style="display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1.25rem;">
      <div class="card stat" style="min-width:140px;">
        <div class="stat-title">–ò–≥—Ä—ã</div>
        <div class="stat-value" style="font-size:2rem;" id="totalGames">{{ overall.total_games }}</div>
      </div>
      <div class="card stat" style="min-width:140px;">
        <div class="stat-title">–ü–æ–±–µ–¥—ã</div>
        <div class="stat-value" style="font-size:2rem;" id="totalWins">{{ overall.wins }}</div>
      </div>
      <div class="card stat" style="min-width:140px;">
        <div class="stat-title">–ü–æ—Ä–∞–∂–µ–Ω–∏—è</div>
        <div class="stat-value" style="font-size:2rem;" id="totalLosses">{{ overall.losses }}</div>
      </div>
      <div class="card stat" style="min-width:140px;">
        <div class="stat-title">% –ø–æ–±–µ–¥</div>
        <div class="stat-value" style="font-size:2rem;" id="winPercent">{{ overall.win_percent }}%</div>
      </div>
      <div class="card stat" style="min-width:140px;">
        <div class="stat-title">–ù–∞–±—Ä–∞–Ω–Ω—ã–µ –æ—á–∫–∏</div>
        <div class="stat-value" style="font-size:2rem;" id="scoredPoints">{{ overall.scored_points }}</div>
      </div>
    </div>

  <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</h2>
    <div class="chart-container" style="margin-bottom: 2rem;">
      <div class="chart-controls" style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
        <label for="yearSelect">–ì–æ–¥:</label>
        <select id="yearSelect" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
          <!-- –û–ø—Ü–∏–∏ –¥–æ–±–∞–≤—è—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
        </select>
        <div class="chart-loading" id="chartLoading" style="display: none; color: var(--text-muted);">
          –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
      </div>
      <div style="position: relative; width: 100%; height: 400px;">
        <canvas id="monthlyStatsChart"></canvas>
      </div>
    </div>

    <h2>üë• –í–∑–∞–∏–º–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏ –≤ –∫–ª—É–±–µ ¬´{{ club.name }}¬ª</h2>
    <div class="tournament-table-wrapper">
      <table class="tournament-table sortable-table" id="h2hTable">
        <thead>
          <tr>
            <th data-type="text">–°–æ–ø–µ—Ä–Ω–∏–∫</th>
            <th data-type="number">–ò–≥—Ä</th>
            <th data-type="number">–ü–æ–±–µ–¥</th>
            <th data-type="number">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</th>
            <th data-type="number">% –ø–æ–±–µ–¥</th>
          </tr>
        </thead>
        <tbody>
          {% for row in h2h_rows %}
            <tr>
              <td><a href="{% url 'tennis_app:player_detail' row.opponent.id %}">{{ row.opponent.full_name }}</a></td>
              <td>{{ row.games }}</td>
              <td>{{ row.wins }}</td>
              <td>{{ row.losses }}</td>
              <td>{{ row.win_pct }}%</td>
            </tr>
          {% empty %}
            <tr><td colspan="5" style="text-align:center; color: var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h2>üéæ –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h2>
    <div class="tournament-table-wrapper">
      <table class="tournament-table">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–¢—É—Ä–Ω–∏—Ä/–¢–∏–ø</th>
            <th>–°–æ–ø–µ—Ä–Ω–∏–∫(–∏)</th>
            <th>–°—á–µ—Ç</th>
            <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
            <th>–°—É–¥—å—è</th>
          </tr>
        </thead>
        <tbody>
          {% for game in games_page %}
            <tr>
              <td>{{ game.date|date:"d.m.Y H:i" }}</td>
              <td>{{ game.tournament_name }}</td>
              <td>{{ game.opponent }}</td>
              <td>{{ game.score }}</td>
              <td>
                <span class="game-result {{ game.result_class }}">{{ game.result }}</span>
              </td>
              <td>{{ game.referee }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" style="text-align:center; color: var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–≥—Ä–∞—Ö</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if games_page.has_other_pages %}
      <div class="pagination-container">
        <div class="pagination">
          {% if games_page.has_previous %}
            <a href="?page=1" class="pagination-link">&laquo; –ü–µ—Ä–≤–∞—è</a>
            <a href="?page={{ games_page.previous_page_number }}" class="pagination-link">‚Äπ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
          {% endif %}

          <span class="pagination-info">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ games_page.number }} –∏–∑ {{ games_page.paginator.num_pages }}
            ({{ games_page.paginator.count }} –∏–≥—Ä{{ games_page.paginator.count|pluralize:"–∞,—ã," }})
          </span>

          {% if games_page.has_next %}
            <a href="?page={{ games_page.next_page_number }}" class="pagination-link">–°–ª–µ–¥—É—é—â–∞—è ‚Ä∫</a>
            <a href="?page={{ games_page.paginator.num_pages }}" class="pagination-link">–ü–æ—Å–ª–µ–¥–Ω—è—è &raquo;</a>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <div style="margin-top:1rem;">
      <a class="btn" href="{% url 'tennis_app:club_detail' club.id %}">‚Üê –ù–∞–∑–∞–¥ –≤ –∫–ª—É–±</a>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const playerId = {{ player.id }};
    const yearSelect = document.getElementById('yearSelect');
    const chartLoading = document.getElementById('chartLoading');
    const ctx = document.getElementById('monthlyStatsChart').getContext('2d');
    const includeDoublesCheckbox = document.getElementById('includeDoublesCheckbox');
    const loadingIndicator = document.getElementById('loadingIndicator');
    let chart = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü (–∫–æ–ø–∏—è –∏–∑ table_sort.js –¥–ª—è —Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
    function initTableSorting() {
        function getCellValue(row, index) {
            const cell = row.children[index];
            if (!cell) return '';
            let txt = cell.textContent.trim();
            return txt;
        }
        
        function parseValue(val, type) {
            if (type === 'number') {
                const num = parseFloat((val || '').replace(/[^0-9+\-\.]/g, '').replace(/\.+/, '$&'));
                return isNaN(num) ? -Infinity : num;
            }
            return (val || '').toLowerCase();
        }
        
        function clearIndicators(ths) {
            ths.forEach(th => {
                th.dataset.sortDirection = '';
                th.classList.remove('sorted-asc', 'sorted-desc');
                const base = th.dataset.baseText;
                if (base) th.textContent = base;
            });
        }
        
        function applyIndicator(th, dir) {
            th.classList.remove('sorted-asc', 'sorted-desc');
            th.classList.add(dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
            const base = th.dataset.baseText || th.textContent.replace(/[‚ñ≤‚ñº]\s*$/, '');
            th.dataset.baseText = base;
            th.textContent = base + (dir === 'asc' ? ' ‚ñ≤' : ' ‚ñº');
        }

        document.querySelectorAll('table.sortable-table').forEach(table => {
            const ths = Array.from(table.querySelectorAll('thead th'));
            ths.forEach((th, idx) => {
                if (th.dataset.sortable === 'false') return;
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                th.style.cursor = 'pointer';
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                const clickHandler = () => {
                    const type = th.dataset.type || 'text';
                    let dir = th.dataset.sortDirection === 'desc' ? 'asc' : 'desc';
                    clearIndicators(ths);
                    th.dataset.sortDirection = dir;
                    applyIndicator(th, dir);
                    const tbody = table.querySelector('tbody');
                    if (!tbody) return;
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    rows.sort((a, b) => {
                        const va = parseValue(getCellValue(a, idx), type);
                        const vb = parseValue(getCellValue(b, idx), type);
                        if (va < vb) return dir === 'asc' ? -1 : 1;
                        if (va > vb) return dir === 'asc' ? 1 : -1;
                        return 0;
                    });
                    const frag = document.createDocumentFragment();
                    rows.forEach(r => frag.appendChild(r));
                    tbody.appendChild(frag);
                };
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
                th.removeEventListener('click', th._sortHandler);
                th._sortHandler = clickHandler;
                th.addEventListener('click', clickHandler);
            });
        });
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –≥–æ–¥–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ª–µ—Ç)
    const currentYear = new Date().getFullYear();
    for (let year = currentYear; year >= currentYear - 4; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        yearSelect.appendChild(option);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞
    async function loadAndDisplayChart(year) {
        chartLoading.style.display = 'inline';
        
        try {
            const includeDoubles = includeDoublesCheckbox.checked;
            const response = await fetch(`/api/player/${playerId}/monthly_stats/?year=${year}&include_doubles=${includeDoubles}`);
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
            
            const data = await response.json();
            displayChart(data.monthly_stats);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
        } finally {
            chartLoading.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function displayChart(monthlyStats) {
        const months = monthlyStats.map(item => item.month_name);
        const totalGames = monthlyStats.map(item => item.total_games);
        const wins = monthlyStats.map(item => item.wins);
        const losses = monthlyStats.map(item => item.losses);
        const winPercent = monthlyStats.map(item => item.win_percent);

        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä',
                        data: totalGames,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        yAxisID: 'y',
                        tension: 0.1
                    },
                    {
                        label: '–ü–æ–±–µ–¥—ã',
                        data: wins,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        yAxisID: 'y',
                        tension: 0.1
                    },
                    {
                        label: '–ü–æ—Ä–∞–∂–µ–Ω–∏—è',
                        data: losses,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        yAxisID: 'y',
                        tension: 0.1
                    },
                    {
                        label: '–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥ (%)',
                        data: winPercent,
                        borderColor: 'rgb(255, 206, 86)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.1,
                        borderDash: [5, 5]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º (${yearSelect.value})`
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.dataset.yAxisID === 'y1') {
                                    label += context.parsed.y + '%';
                                } else {
                                    label += context.parsed.y;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '–ú–µ—Å—è—Ü'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä'
                        },
                        min: 0
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: '–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥ (%)'
                        },
                        min: 0,
                        max: 100,
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function updateOverallStats() {
        loadingIndicator.style.display = 'block';
        
        try {
            const includeDoubles = includeDoublesCheckbox.checked;
            const url = new URL(window.location);
            url.searchParams.set('include_doubles', includeDoubles);
            
            const response = await fetch(url.toString());
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
            
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            document.getElementById('totalGames').textContent = doc.getElementById('totalGames').textContent;
            document.getElementById('totalWins').textContent = doc.getElementById('totalWins').textContent;
            document.getElementById('totalLosses').textContent = doc.getElementById('totalLosses').textContent;
            document.getElementById('winPercent').textContent = doc.getElementById('winPercent').textContent;
            document.getElementById('scoredPoints').textContent = doc.getElementById('scoredPoints').textContent;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É H2H
            const newH2hTable = doc.getElementById('h2hTable');
            document.getElementById('h2hTable').innerHTML = newH2hTable.innerHTML;
            
            // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
            initTableSorting();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            history.replaceState(null, '', url.toString());
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É');
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–æ–¥–∞
    yearSelect.addEventListener('change', function() {
        loadAndDisplayChart(this.value);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞
    includeDoublesCheckbox.addEventListener('change', function() {
        updateOverallStats();
        loadAndDisplayChart(yearSelect.value);
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadAndDisplayChart(currentYear);
});
</script>
{% endblock %}
