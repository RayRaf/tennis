{% extends 'base.html' %}
{% load static %}
{% block title %}{{ club.name }} ‚Äî –ö–ª—É–±{% endblock %}
{% block content %}
  <h1>üèõÔ∏è {{ club.name }}</h1>
  <div class="content">
    <!-- –ñ–∏–≤–∞—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è —Å—á–µ—Ç–∞ -->
    <div id="liveGameSection" style="display: none; margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(93, 139, 255, 0.1), rgba(67, 233, 123, 0.1)); border: 2px solid rgba(93, 139, 255, 0.3); border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);">
      <h2 style="margin: 0 0 1rem 0; text-align: center;">üî¥ –ò–¥–µ—Ç —Ç–æ–≤–∞—Ä–∏—â–µ—Å–∫–∞—è –ø–∞—Ä—Ç–∏—è</h2>
      <div style="display: flex; justify-content: space-around; align-items: center; gap: 2rem; flex-wrap: wrap;">
        <div style="text-align: center; flex: 1; min-width: 200px;">
          <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;" id="livePlayer1Name">‚Äî</div>
          <div style="font-size: 3rem; font-weight: 700; color: #43e97b;" id="liveScore1">0</div>
        </div>
        <div style="font-size: 2rem; font-weight: 700;">VS</div>
        <div style="text-align: center; flex: 1; min-width: 200px;">
          <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;" id="livePlayer2Name">‚Äî</div>
          <div style="font-size: 3rem; font-weight: 700; color: #5d8bff;" id="liveScore2">0</div>
        </div>
      </div>
      <div style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
        <span id="liveServerInfo">–ü–æ–¥–∞–µ—Ç: ‚Äî</span>
      </div>
    </div>

    <h2>üìÖ –°–æ–±—ã—Ç–∏—è –∫–ª—É–±–∞</h2>
    <div class="participants-list">
      <ul>
        {% for event in events %}
          <li>
            <span>{{ event.title }}</span>
            <span class="seed-badge">{{ event.date|date:"d.m.Y H:i" }}</span>
          </li>
        {% empty %}
          <li>–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</li>
        {% endfor %}
      </ul>
    </div>
    {% if is_club_admin %}
      <a class="btn success" href="{% url 'tennis_app:add_event' club.id %}">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</a>
    {% endif %}

    <h2>üèÜ –¢—É—Ä–Ω–∏—Ä—ã –∫–ª—É–±–∞</h2>
    <div class="participants-list">
      <ul>
        {% for tournament in tournaments %}
          <li>
            <a href="{% url 'tennis_app:tournament_detail' tournament.id %}" style="text-decoration: none; color: inherit;">
              <span>{{ tournament.name }}</span>
            </a>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <span class="seed-badge">{{ tournament.start_date }}</span>
              <span class="match-round">{{ tournament.get_tournament_type_display }}</span>
            </div>
          </li>
        {% empty %}
          <li>–ù–µ—Ç —Ç—É—Ä–Ω–∏—Ä–æ–≤</li>
        {% endfor %}
      </ul>
    </div>
    {% if is_club_admin %}
      <a class="btn success" href="{% url 'tennis_app:add_tournament' club.id %}">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä</a>
    {% endif %}

    <h2>üë• –ò–≥—Ä–æ–∫–∏ –∫–ª—É–±–∞</h2>
    <div class="tournament-table-wrapper" style="margin-bottom: 1.5rem;">
      <table class="tournament-table sortable-table">
        <thead>
          <tr>
            <th data-type="text">–ò–≥—Ä–æ–∫</th>
            <th data-type="number">–†–µ–π—Ç–∏–Ω–≥</th>
            <th data-type="number">–ü–æ–±–µ–¥</th>
            <th data-type="number">–ò–≥—Ä</th>
            <th data-type="number">% –ø–æ–±–µ–¥</th>
          </tr>
        </thead>
        <tbody>
          {% for player in players %}
            <tr>
              <td><strong><a href="{% url 'tennis_app:player_detail' player.id %}" style="text-decoration:none; color:inherit;">{{ player.full_name }}</a></strong></td>
              <td>{{ player.rating }}</td>
              <td>{{ player.stats.wins }}</td>
              <td>{{ player.stats.total_games }}</td>
              <td>{{ player.stats.win_percent }}%</td>
            </tr>
          {% empty %}
            <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if is_club_admin %}
      <a class="btn success" href="{% url 'tennis_app:add_player' club.id %}">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</a>
    {% endif %}

    <div style="margin: 2rem 0; height: 2px; background: linear-gradient(90deg, transparent, var(--primary-gradient), transparent); border-radius: 1px;"></div>

    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; align-items: center;">
      {% if is_club_admin %}
        <a class="btn primary" href="{% url 'tennis_app:friend_play' %}?club_id={{ club.id }}">‚öîÔ∏è –¢–æ–≤–∞—Ä–∏—â–µ—Å–∫–∞—è –ø–∞—Ä—Ç–∏—è</a>
        <a class="btn secondary" href="{% url 'tennis_app:invite_admin' club.id %}">üìß –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</a>
      {% endif %}
      {% if user.is_authenticated %}
        <a class="btn warning" href="{% url 'tennis_app:accept_invite' %}">üì¨ –ü—Ä–∏–Ω—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</a>
      {% endif %}
      <span class="admin-status-badge {% if is_club_admin %}admin-status--yes{% else %}admin-status--no{% endif %}">
        {% if is_club_admin %}–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–ª—É–±–∞{% else %}–í—ã –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–ª—É–±–∞{% endif %}
      </span>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  // WebSocket –¥–ª—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ —Å—á–µ—Ç–∞
  const clubId = {{ club.id }};
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.host}/ws/friendly_game/${clubId}/`;
  
  let websocket = new WebSocket(wsUrl);
  
  websocket.onopen = function(e) {
    console.log('WebSocket connected for live game updates');
  };
  
  websocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    
    if (data.type === 'game_update') {
      const gameData = data.game_data;
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é —Å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–µ–π
      document.getElementById('liveGameSection').style.display = 'block';
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      document.getElementById('livePlayer1Name').textContent = gameData.player1 || '‚Äî';
      document.getElementById('livePlayer2Name').textContent = gameData.player2 || '‚Äî';
      document.getElementById('liveScore1').textContent = gameData.score1 || 0;
      document.getElementById('liveScore2').textContent = gameData.score2 || 0;
      
      // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–∞—é—â–µ–º
      const serverName = gameData.server === 1 ? gameData.player1 : gameData.player2;
      document.getElementById('liveServerInfo').textContent = `–ü–æ–¥–∞–µ—Ç: ${serverName}`;
      
    } else if (data.type === 'game_end') {
      const gameData = data.game_data;
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      setTimeout(() => {
        document.getElementById('liveGameSection').style.display = 'none';
        alert(`–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${gameData.winner}`);
      }, 3000);
    }
  };
  
  websocket.onclose = function(e) {
    console.log('WebSocket disconnected, reconnecting in 3 seconds...');
    setTimeout(() => {
      location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    }, 3000);
  };
  
  websocket.onerror = function(e) {
    console.error('WebSocket error:', e);
  };
</script>
{% endblock %}
